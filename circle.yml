machine:
  services:
    - docker
  environment:
    NODE_ENV: test
    SECRET: SECRET
    DATABASE_HOST: localhost
    DATABASE_PORT: 5432
    DATABASE_NAME: circle_test
    DATABASE_USER: ubuntu
    CODECOV_TOKEN: 5bfef61d-4c62-4a4d-a5fb-379f62ec85c5

dependencies:
  cache_directories:
    - ~/docker
  override:
    - docker info

test:
  pre:
    - docker build -t jasper-ai/jasper-iam:$CIRCLE_SHA1 .
  override:
    - |
      docker run jasper-ai/jasper-iam:$CIRCLE_SHA1 npm run audit
    - |
      docker run \
        --net=host \
        --env NODE_ENV=$NODE_ENV \
        --env SECRET=$SECRET \
        --env DATABASE_HOST=$DATABASE_HOST \
        --env DATABASE_PORT=$DATABASE_PORT \
        --env DATABASE_NAME=$DATABASE_NAME \
        --env DATABASE_USER=$DATABASE_USER \
        --env CODECOV_TOKEN=$CODECOV_TOKEN \
        jasper-ai/jasper-iam:$CIRCLE_SHA1 npm run test:coverage
    - |
      docker run \
        -p 3000:3000 \
        --net=host \
        --env NODE_ENV=$NODE_ENV \
        --env SECRET=$SECRET \
        --env DATABASE_HOST=$DATABASE_HOST \
        --env DATABASE_PORT=$DATABASE_PORT \
        --env DATABASE_NAME=$DATABASE_NAME \
        --env DATABASE_USER=$DATABASE_USER \
        jasper-ai/jasper-iam:$CIRCLE_SHA1
    - sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000/healthcheck

deployment:
  build:
    branch: /^((?!master).)*$/
    commands:
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
      - docker push kkemple/jasper-iam:$CIRCLE_SHA1
  latest:
    branch: master
    commands:
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
      - docker build -t kkemple/jasper-iam:latest .
      - docker push kkemple/jasper-iam:latest
